<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h1 class="fw-bold mb-1">
      <i class="bi bi-chat-dots-fill text-primary me-2"></i>Messages
    </h1>
    <p class="text-muted mb-0">Your conversations with other users</p>
  </div>
</div>

<% if @conversations.any? %>
  <div class="card">
    <ul class="list-group list-group-flush">
      <% @conversations.each do |conversation| %>
        <% other_user = conversation.other_party(current_user) %>
        <% last_message = conversation.last_message %>
        <% unread_count = conversation.unread_messages_for(current_user).count %>

        <%= link_to conversation_path(conversation), class: "list-group-item list-group-item-action #{'bg-light' if unread_count > 0}" do %>
          <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
              <div class="avatar me-3">
                <%= other_user.name.first.upcase %>
              </div>
              <div>
                <div class="d-flex align-items-center">
                  <strong class="<%= 'text-primary' if unread_count > 0 %>"><%= other_user.name %></strong>
                  <% if unread_count > 0 %>
                    <span class="badge bg-primary ms-2"><%= unread_count %></span>
                  <% end %>
                </div>
                <% if last_message %>
                  <p class="mb-0 small text-muted text-truncate" style="max-width: 400px;">
                    <% if last_message.user == current_user %>
                      <span class="text-muted">You: </span>
                    <% end %>
                    <%= truncate(last_message.body, length: 60) %>
                  </p>
                <% else %>
                  <p class="mb-0 small text-muted fst-italic">No messages yet</p>
                <% end %>
              </div>
            </div>
            <div class="text-end">
              <% if last_message %>
                <small class="text-muted">
                  <%= time_ago_in_words(last_message.created_at) %> ago
                </small>
              <% end %>
              <br>
              <i class="bi bi-chevron-right text-muted"></i>
            </div>
          </div>
        <% end %>
      <% end %>
    </ul>
  </div>
<% else %>
  <div class="card">
    <div class="card-body text-center py-5">
      <i class="bi bi-chat-dots text-muted" style="font-size: 4rem;"></i>
      <h4 class="mt-3">No Conversations Yet</h4>
      <p class="text-muted mb-4">Start a conversation by messaging a trip driver or passenger.</p>
      <%= link_to trips_path, class: "btn btn-primary" do %>
        <i class="bi bi-search me-1"></i> Browse Trips
      <% end %>
    </div>
  </div>
<% end %>
